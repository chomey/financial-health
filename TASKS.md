# Tasks

- [x] Task 1: [ARCH] Initialize Next.js project with Tailwind CSS and Vitest ‚Äî Scaffold a Next.js 15 app with TypeScript (strict mode), Tailwind CSS v4, and Vitest. Run `npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --no-import-alias` (use src/ directory). Add Vitest with `npm install -D vitest @vitejs/plugin-react jsdom @testing-library/react @testing-library/jest-dom`. Create `vitest.config.ts` with jsdom environment and React plugin. Configure a custom Tailwind color palette in the CSS theme: warm greens (emerald/teal for positive metrics), warm neutrals (stone/slate for backgrounds), soft blues (for info/links), and a celebratory gold/amber for achievements. Add a `"test": "vitest run"` script to package.json. Verification: `npm run dev` serves a styled page at localhost:3000, `npm test` runs with 0 tests found (no error). [@devops]

- [x] Task 2: Set up Playwright screenshot & test infrastructure ‚Äî Install Playwright with `npm init playwright@latest` (use tests/e2e/ directory, install browsers). Configure `playwright.config.ts` with baseURL `http://localhost:3000`, webServer that runs `npm run dev`, and a screenshot helper utility at `tests/e2e/helpers.ts` that captures and saves screenshots to `screenshots/` with descriptive filenames. Create `.gitattributes` to track `*.png *.jpg *.jpeg *.gif *.webp *.svg` via Git LFS. Write one smoke test (`tests/e2e/smoke.spec.ts`) that loads `/`, verifies the page renders with the app title, and saves a screenshot. Verification: `npx playwright test` passes, screenshot appears in `screenshots/`. [@qa]

- [x] Task 3: Build app shell & responsive layout ‚Äî Create the main page layout: a left-hand entry panel and a right-hand dashboard panel, side by side on desktop, stacked on mobile. Add an app header with the name "Financial Health Snapshot" and a warm tagline (e.g., "Your finances at a glance ‚Äî no judgment, just clarity"). All panels should have subtle hover lift effects, smooth transitions, and a polished empty state. [@frontend]

- [x] Task 4: Build asset entry section with mock data ‚Äî Create the Assets card in the entry panel. Pre-populate with 2-3 example assets (e.g., "Savings Account: $12,000", "TFSA: $35,000"). Each row shows a category label and dollar amount. Rows highlight on hover, show a delete button on hover. An "Add Asset" button at the bottom smoothly expands a new row with inline editing (click to type category name and amount). Support category suggestions for CA (TFSA, RRSP, RESP, FHSA, LIRA) and US (401k, IRA, Roth IRA, 529, HSA) plus universal ones (Savings, Checking, Brokerage, Home Equity, Vehicle, Other). All values click-to-edit with smooth focus transitions. [@frontend]

- [x] Task 5: Build debt entry section ‚Äî Create the Debts card, same interaction pattern as assets. Pre-populate with 1-2 example debts (e.g., "Mortgage: $280,000", "Car Loan: $15,000"). Category suggestions: Mortgage, Car Loan, Student Loan, Credit Card, Line of Credit, Personal Loan, Other. Rows have hover highlight, hover-reveal delete, click-to-edit values, smooth add/remove animations. [@frontend]

- [x] Task 6: Build income & expense entry sections ‚Äî Create two cards: Monthly Income and Monthly Expenses. Income has category suggestions (Salary, Freelance, Investment Income, Side Hustle, Other). Expenses has flexible categories (Rent/Mortgage Payment, Childcare, Groceries, Subscriptions, Transportation, Insurance, Utilities, "Monthly Expenses" as a catch-all, Other). Users can be as granular or broad as they want. Same interaction pattern: hover highlights, click-to-edit, smooth add/remove. Show a monthly total at the bottom of each card that animates when values change. [@frontend]

- [x] Task 7: Build financial goals section ‚Äî Create a Goals card. Each goal has a name (e.g., "New Car", "Emergency Fund", "Vacation"), a target amount, and a current amount saved. Show an animated progress bar for each goal. Add button expands a new inline goal. Progress bars should have smooth fill animations, color transitions (warm to green as they approach 100%), and a celebratory glow effect when a goal is reached. Hover on a goal shows a tooltip with percentage and remaining amount. [@frontend]

- [x] Task 8: Build snapshot dashboard with mock calculations ‚Äî Create the right-hand dashboard panel. Display four key metric cards: Net Worth (assets minus debts), Monthly Surplus/Deficit (income minus expenses), Financial Runway (months of expenses covered by liquid assets), and Debt-to-Asset Ratio. Use hardcoded mock values initially. Each metric card should have a large number that counts up on load, a label, a subtle icon, and a hover tooltip explaining what the metric means. Cards lift on hover. Use encouraging color coding (greens for positive metrics). [@frontend]

- [x] Task 9: Build positive insights engine ‚Äî Below the metric cards, add an Insights section that generates 3-5 human-readable, encouraging messages based on the financial data. Use the actual values from the entry panel (wire the state). Examples: "You could comfortably cover about 18 months of expenses ‚Äî that's a strong safety net", "Your savings are growing nicely ‚Äî you're 60% of the way to your New Car goal", "You're spending less than you earn each month ‚Äî that surplus is building your future". Insights should have a warm card style, subtle entrance animations, and an icon per insight type (shield for runway, trending-up for surplus, target for goals). [@fullstack]

- [x] Task 10: Wire all entry sections to shared state ‚Äî Connect assets, debts, income, expenses, and goals to a shared React state (useReducer or useState). Dashboard metrics should recalculate live as the user edits any value. Numbers in the dashboard should animate smoothly when they change. Ensure add/edit/delete in any section immediately updates the dashboard. [@fullstack]

- [x] Task 11: Implement URL state persistence ‚Äî Encode the full app state (all assets, debts, income, expenses, goals) as base85-encoded JSON in a `s=` query param. Update the URL on every state change (using `replaceState`, not `pushState`, to avoid polluting browser history). On page load, read the `s=` param and restore state. Add a "Copy Link" button in the header that copies the current URL to clipboard with a brief "Copied!" animation. Verify that reloading the page preserves all entered data exactly. [@fullstack]

- [x] Task 12: Add region toggle for CA/US financial vehicles ‚Äî Add a toggle in the header or settings area that lets users choose their region (Canada, United States, or Both). The toggle should use flag icons or short labels (CA/US). When a region is selected, asset and debt category suggestions should filter to show only relevant vehicles (e.g., CA shows TFSA/RRSP but not 401k). "Both" shows all. The selection should persist in the URL state. Smooth transition when toggling. [@frontend]

- [x] Task 13: Add micro-interactions and polish ‚Äî Audit the entire UI for interactivity polish. Ensure: all buttons have hover, focus, and active states; all cards lift on hover with shadow transitions; number inputs have smooth focus rings; add/remove items have slide-in/slide-out animations; the "runway" metric has a special celebratory glow when it exceeds 12 months; tooltips appear on hover for financial terms (e.g., "Net Worth", "Runway"); empty states have friendly illustrations or messages encouraging the user to add their first item. [@frontend]

- [x] Task 14: Mobile responsiveness pass ‚Äî Ensure the entire app works beautifully on mobile. Entry panel stacks above dashboard. Cards are full-width. Touch targets are large enough (min 44px). Inline editing works well on mobile keyboards. The "Copy Link" button is easily accessible. Test at 375px, 768px, and 1024px widths. [@frontend]

- [x] Task 15: [MILESTONE] Full E2E test ‚Äî Write a comprehensive end-to-end test that: loads the app, adds 3 assets, 2 debts, income and expenses, and a goal; verifies dashboard metrics update correctly; copies the URL; reloads the page; verifies all data is preserved; toggles region and verifies category suggestions change. Capture screenshots at each step. [@qa]

- [x] Task 16: Fix setState-during-render bug in all entry components ‚Äî All 5 entry components (AssetEntry, DebtEntry, IncomeEntry, ExpenseEntry, GoalEntry) call `onChange?.(next)` inside a `setState` updater function, triggering parent state updates during rendering. Fix by moving `onChange` to a `useEffect` that fires when internal state changes. Files: `src/components/AssetEntry.tsx`, `DebtEntry.tsx`, `IncomeEntry.tsx`, `ExpenseEntry.tsx`, `GoalEntry.tsx`. Verification: `npm run dev` ‚Äî no console warnings about setState during render. [@fullstack]

- [x] Task 17: Make region toggle visibly affect the UI ‚Äî Toggling CA/US/Both currently has no visible effect unless you're mid-edit on an asset. Fix by: passing `region` prop to DebtEntry and adding CA/US debt categories; showing flag badges (üá®üá¶/üá∫üá∏) next to region-specific categories in dropdowns and saved items; adding a brief visual pulse on entry cards when region changes. Files: `src/app/page.tsx`, `src/components/DebtEntry.tsx`, `src/components/AssetEntry.tsx`. [@frontend]

- [x] Task 18: Replace mortgage mock data with linked Property card ‚Äî Remove "Mortgage" from debts and "Home Equity" from assets. Add a new Property section with linked value/mortgage/equity: new `Property` interface (`{ id, name, value, mortgage }` with derived equity), new `PropertyEntry.tsx` component with same interaction patterns as other cards. Property values count toward net worth but NOT toward financial runway (illiquid). Default mock: "Home" / $450k value / $280k mortgage / $170k equity. Update URL state encoding, metrics calculations, insights. Files: `src/lib/financial-state.ts`, `src/lib/url-state.ts`, `src/app/page.tsx`, new `src/components/PropertyEntry.tsx`, `src/components/AssetEntry.tsx`, `src/components/DebtEntry.tsx`, `src/lib/insights.ts`. [@fullstack]

- [x] Task 19: Fix z-index and mouseover issues in dashboard column ‚Äî Tooltips and hover states broken in the right column. Fix z-index stacking, ensure tooltips aren't clipped by overflow, and verify all mouseover interactions work. Files: `src/components/SnapshotDashboard.tsx`, `src/app/page.tsx`. [@frontend]

- [x] Task 20: Fix hydration mismatch in PropertyEntry ‚Äî Server-rendered property IDs don't match client IDs (e.g., `data-testid="equity-13"` on server vs `data-testid="equity-p1"` on client), causing React hydration errors. The root cause is that mock data IDs are generated with `Date.now()` or `Math.random()` which differ between server and client. Fix by using stable, deterministic IDs for default/mock data (e.g., `"p1"`, `"p2"`). Check all other entry components (AssetEntry, DebtEntry, IncomeEntry, ExpenseEntry, GoalEntry) for the same pattern and fix them too. Verification: `npm run dev` ‚Äî no hydration mismatch warnings in the browser console. [@fullstack]

- [x] Task 21: Make region toggle obviously useful ‚Äî The CA/US/Both toggle currently only affects category suggestions when adding new items and shows a subtle 0.6s pulse. Users can't tell what it does. Fix by: (1) adding a visible label or tooltip explaining the toggle's purpose (e.g., "Filter account types by region"); (2) when a region is selected, visually dim or badge existing items that don't belong to that region (e.g., if US is selected, show TFSA rows with a subtle "CA" badge and slightly muted styling); (3) group or sort suggestions by region with section headers in the dropdown; (4) show a brief toast or inline message on toggle like "Showing US account types" so the user gets immediate feedback. The goal: a user toggling this should instantly understand what changed and why. [@frontend]

- [x] Task 22: Add ROI and monthly contributions to assets ‚Äî Each asset should optionally support an expected annual ROI percentage and a monthly contribution amount. Add two new optional fields to the Asset interface: `roi` (number, annual %) and `monthlyContribution` (number, $). In the UI, show these as secondary fields below each asset row ‚Äî greyed out placeholder text like "Annual return %" and "Monthly contribution" that become editable on click. When set, display them as subtle badges (e.g., "7% ROI", "+$500/mo") next to the asset value. Pre-populate smart defaults for known account types: 401k/IRA/Roth IRA ‚Üí 7% ROI, TFSA/RRSP ‚Üí 5% ROI, Savings ‚Üí 2% ROI ‚Äî shown as greyed-out suggestions the user can accept or override. These values feed into the projection graph (Task 25). Update URL state encoding to persist ROI and contribution values. [@fullstack]

- [x] Task 23: Add interest rate and monthly payment to properties ‚Äî Expand the Property interface with optional fields: `interestRate` (annual %), `monthlyPayment` ($), and `amortizationYears` (number). Display these as secondary detail fields below each property row, similar to Task 22's approach ‚Äî greyed-out placeholders that become editable on click. When set, show computed info: monthly interest cost vs principal portion, total interest over remaining term, and estimated payoff date. The interest rate should affect the property's impact on growth projections (Task 25) ‚Äî mortgage interest is a cost that reduces net worth growth. Smart defaults: suggest 5% interest rate, calculate a reasonable monthly payment from the mortgage amount. Update URL state encoding. Files: `src/lib/financial-state.ts`, `src/components/PropertyEntry.tsx`, `src/lib/url-state.ts`. [@fullstack]

- [x] Task 24: Add interest rate to debts ‚Äî Each debt should optionally support an interest rate (annual %) and minimum monthly payment. Add `interestRate` and `monthlyPayment` optional fields to the debt interface. Show as greyed-out secondary fields below each debt row, editable on click. When set, display as subtle badges (e.g., "19.9% APR", "$150/mo"). Pre-populate smart defaults for known debt types: Credit Card ‚Üí 19.9%, Car Loan ‚Üí 6%, Student Loan ‚Üí 5%, Personal Loan ‚Üí 8%. These values feed into the projection graph (Task 25) and insights engine (prioritize paying off high-interest debt first). Update URL state and insights. [@fullstack]

- [x] Task 25: Build financial projection timeline graph ‚Äî Add a time-series projection chart below the dashboard metrics. Install a lightweight chart library (recharts or chart.js). The graph should project net worth over 1‚Äì30 years (user-adjustable slider) using data from assets (with ROI + contributions from Task 22), properties (with interest from Task 23), debts (with interest + payments from Task 24), and monthly surplus. Show multiple lines: (1) Total Net Worth projection, (2) one line per goal showing when the goal target is reached (with a marker at the intersection), (3) debt-free date (where all debts hit $0), (4) key milestones like "first $100k", "first $1M". The graph should be interactive ‚Äî hover to see values at any point in time. Include a toggle for optimistic/conservative/custom scenarios. Make it responsive and visually polished with smooth animations on data changes. [@fullstack]

- [x] Task 26: [MILESTONE] Full E2E test for new features ‚Äî Comprehensive E2E test covering: asset ROI and contribution fields, property interest rate and payment fields, debt interest rate fields, projection graph rendering with multiple lines, goal target intersections on the graph, timeline slider interaction, region toggle visibility improvements. Capture screenshots at each step. [@qa]

- [x] Task 27: Move projection chart to top of dashboard ‚Äî The financial projection timeline graph (ProjectionChart) currently renders below the dashboard metrics. Move it to the very top of the dashboard panel so it's the first thing users see. The projection is the most impactful visual ‚Äî it should be above the metric cards and insights. Reorder the rendering in `SnapshotDashboard.tsx` (or `page.tsx`, wherever the dashboard column is composed). Ensure the chart remains responsive and the rest of the dashboard flows naturally below it. [@frontend]

- [x] Task 28: Add explanatory legend for projection scenario lines ‚Äî The projection chart shows conservative/moderate/optimistic lines but doesn't explain what they mean. Add a visible legend or info section near the chart that explains: **Conservative** = lower-bound returns (e.g., 2-3% below moderate, accounts for market downturns), **Moderate** = expected returns based on entered ROI values, **Optimistic** = upper-bound returns (e.g., 2-3% above moderate, best-case growth). Show this as a collapsible or always-visible key below the chart with colored line samples matching the chart colors. Also add a brief tooltip on each scenario toggle button explaining the assumption. [@frontend]

- [x] Task 29: Show loan payoff timeline on debts ‚Äî For each debt that has an interest rate and monthly payment set, calculate and display the estimated payoff date and total interest paid. Show this as an inline summary below the debt row (e.g., "Paid off in 4 years 2 months ¬∑ $3,200 total interest"). Use standard amortization math: apply monthly interest (`rate/12`) to the balance, subtract the payment, iterate until balance reaches 0. If the monthly payment is less than monthly interest (i.e., the debt will never be paid off), show a warning like "Payment doesn't cover interest ‚Äî balance will grow". This calculation should be pure client-side in a utility function in `src/lib/`. Update DebtEntry.tsx to display the computed payoff info. [@fullstack]

- [x] Task 30: Support different income frequencies ‚Äî Currently all income is assumed monthly. Add a frequency field to IncomeItem: monthly (default), weekly, biweekly, quarterly, semi-annually, annually. Show frequency as a subtle dropdown or badge next to each income row (e.g., "Quarterly" badge). Internally normalize all income to monthly equivalent for dashboard calculations (weekly √ó 52/12, biweekly √ó 26/12, quarterly √∑ 3, semi-annually √∑ 6, annually √∑ 12). The monthly total at the bottom of IncomeEntry should show the normalized monthly total. Update the IncomeItem interface in `financial-state.ts`, the IncomeEntry component, URL state encoding, and all calculation functions that use income. [@fullstack]

- [x] Task 31: Remove region toggle, add account-type subdivisions to asset/debt dropdowns ‚Äî Remove the CA/US/Both region toggle entirely (RegionToggle component, region field from state, all region-filtering logic). Instead, restructure the category suggestion dropdowns in AssetEntry and DebtEntry to show grouped subdivisions: a "Canada" section header with CA-specific types (TFSA, RRSP, RESP, FHSA, LIRA), a "USA" section header with US-specific types (401k, IRA, Roth IRA, 529, HSA), and a "General" section with universal types (Savings, Checking, Brokerage, etc.). Users pick what applies to them ‚Äî no toggle needed. Remove region from FinancialState interface, URL state encoding, and all components that reference it. Clean up RegionToggle.tsx (delete it), remove region-based dimming/badges from entry components, and remove region from mock data. [@fullstack]

- [x] Task 32: Add stock/equity holdings with live price lookup ‚Äî Add a new "Stocks & Equity" section with a dedicated StockEntry component. Each holding has: ticker symbol (e.g., AAPL, MSFT), number of shares, and current price. When a user types a ticker, fetch the live price from a free API (e.g., Yahoo Finance via a public endpoint, or finnhub.io free tier). Auto-populate the price field and show a "Last updated" timestamp. The total value (shares √ó price) displays alongside each holding and counts toward total assets and net worth. Include a manual price override for unlisted equity (private stock, RSUs with known value). Add a refresh button to re-fetch all prices. Support optional cost basis field to show gain/loss. Store ticker, shares, and manual price override in URL state (don't persist fetched prices ‚Äî re-fetch on load). [@fullstack]

- [x] Task 33: Make projection chart full-width above the two-column layout ‚Äî The projection chart currently sits inside the right dashboard column. Move it out of the two-column layout so it spans the full width of the page, rendered above the entry panel and dashboard columns. Update `page.tsx` to render ProjectionChart in its own full-width section before the two-column grid. Ensure it still receives all the financial data it needs and remains responsive. [@frontend]

- [x] Task 34: Fix mortgage breakdown to show changing interest/principal over time ‚Äî The property mortgage info currently shows a static "Monthly interest" / "Monthly principal" split based on the current balance, which is misleading ‚Äî with fixed payments, the interest portion decreases and principal portion increases each month. Fix by: (1) relabeling to "Current month: $X interest / $Y principal" to make clear it's a snapshot; (2) adding a small summary showing how the split changes, e.g., "First year avg: $X interest ¬∑ Last year avg: $Y interest" or a mini sparkline/bar showing the amortization curve; (3) optionally add a "View schedule" expandable that shows a condensed year-by-year table (year, interest paid that year, principal paid, remaining balance). The `computeMortgageBreakdown` function should stay as-is (it's correct for current month), but add a new `computeAmortizationSchedule` utility that returns yearly summaries. Files: `src/components/PropertyEntry.tsx`, `src/lib/` (new or existing util). [@fullstack]

- [x] Task 35: Prevent double-counting of investment contributions in surplus ‚Äî Asset monthly contributions (from Task 22) come out of income but aren't reflected in expenses, so surplus is overstated and projections may double-count growth. Fix by: (1) In the Expenses section, auto-generate a read-only "Investment Contributions" summary row that sums all asset monthly contributions ‚Äî styled distinctly (e.g., italic, with a link icon or "auto" badge) so users know it's derived, not manually entered. (2) Update `computeTotals` to include total monthly contributions in the expense total so surplus = income ‚àí expenses ‚àí contributions. (3) Ensure the projection engine uses per-asset contributions for asset growth and does NOT also reinvest surplus ‚Äî surplus should represent truly unallocated money. (4) If a user removes a contribution from an asset, the auto-generated expense row updates immediately. Files: `src/components/ExpenseEntry.tsx`, `src/lib/financial-state.ts`, projection calculation logic. [@fullstack]

- [x] Task 36: [MILESTONE] Full E2E test for tasks 27-35 ‚Äî Comprehensive E2E test covering: projection chart full-width position at top of page, scenario legend visibility and content, debt payoff timeline display with amortization math verification, income frequency selector and normalized totals, grouped category dropdowns without region toggle, stock entry with ticker input and price display. Capture screenshots at each step. [@qa]

- [x] Task 37: Add country and jurisdiction fields to FinancialState and URL encoding ‚Äî Extend the `FinancialState` interface with `country?: "CA" | "US"` and `jurisdiction?: string` (province/state code). Add `co` and `ju` fields to `CompactState` in url-state.ts. Update `toCompact` and `fromCompact` to serialize/deserialize these fields. Update `INITIAL_STATE` to default to `country: "CA"`, `jurisdiction: "ON"`. Ensure backward compatibility: if `co`/`ju` are missing from decoded state, default to `"CA"`/`"ON"`. Update `page.tsx` to pass country/jurisdiction through state and into `updateURL`. Write unit tests for round-trip encoding of country/jurisdiction. [@backend]

- [x] Task 38: Add incomeType field to IncomeItem and URL encoding ‚Äî Extend `IncomeItem` interface in `IncomeEntry.tsx` with `incomeType?: "employment" | "capital-gains" | "other"`. Update `CompactIncome` in url-state.ts with `it?: string` field. Update `toCompact`/`fromCompact` to handle the new field (omit when undefined or "employment" to save URL space). Update `CATEGORY_SUGGESTIONS` to include "Capital Gains" and "Dividends" as categories. Write unit tests for round-trip encoding of income items with incomeType. [@backend]

- [x] Task 39: Build Canadian federal and provincial tax bracket tables ‚Äî Create `src/lib/tax-tables.ts` with 2025 Canadian federal tax brackets and all 13 provincial/territorial bracket tables. Each jurisdiction is a named export: `CA_FEDERAL_2025`, `CA_ON_2025`, `CA_BC_2025`, etc. Structure: `{ brackets: { min: number; max: number; rate: number }[]; basicPersonalAmount: number }`. Include the capital gains inclusion rate (50% on first $250k, 66.67% above for 2024+). Add a lookup function `getCanadianBrackets(province: string, year?: number)` that returns `{ federal, provincial }`. Include JSDoc comments citing CRA sources. Write unit tests verifying known tax amounts (e.g., $100k ON income should produce approximately $X federal + $Y provincial). [@backend]

- [x] Task 40: Build US federal and state tax bracket tables ‚Äî Extend `src/lib/tax-tables.ts` with 2025 US federal tax brackets (single filer, as simplest default) and state income tax tables for all 50 states + DC. States with no income tax (TX, FL, WA, NV, WY, SD, AK, NH, TN) get empty bracket arrays. Include standard deduction amounts. For US capital gains, add separate long-term capital gains brackets (0%/15%/20% thresholds). Add `getUSBrackets(state: string, year?: number)` lookup function. Write unit tests verifying known tax amounts for a few states (CA, NY, TX, FL). [@backend]

- [x] Task 41: Build tax computation engine ‚Äî Create `src/lib/tax-engine.ts` with the core computation function: `computeTax(annualIncome: number, incomeType: "employment" | "capital-gains" | "other", country: "CA" | "US", jurisdiction: string): TaxResult` where `TaxResult = { federalTax: number; provincialStateTax: number; totalTax: number; effectiveRate: number; afterTaxIncome: number; marginalRate: number }`. For employment/other income: apply progressive brackets normally. For capital gains: in Canada, apply 50% inclusion rate then run through brackets; in US, use long-term capital gains rate schedule. Apply basic personal amount / standard deduction. Write comprehensive unit tests covering: employment income in multiple jurisdictions, capital gains in both countries, edge cases (zero income, very high income, no-tax states). [@backend]

- [x] Task 42: Add country and jurisdiction selector UI to page header ‚Äî Add a country selector (dropdown or segmented control showing flag + "Canada" / "USA") and a dependent province/state selector in the page header area, next to the "Copy Link" button. When country changes, reset jurisdiction to a sensible default (ON for CA, CA for US). Province/state dropdown shows full names with abbreviation codes. Use the same warm styling as the rest of the app. Both selectors persist through the existing URL state mechanism. Style: compact, not dominating the header. Add unit tests for the selector component. [@frontend]

- [x] Task 43: Add income type selector to IncomeEntry rows ‚Äî Add an income type selector to each income row in `IncomeEntry.tsx`. Show as a small dropdown or pill next to the frequency selector: "Employment" (default, can be hidden/implied), "Capital Gains", "Other". When "Capital Gains" is selected, show a subtle badge or color change on the row to visually distinguish it. The income type selector should also appear in the "add new income" flow. Update category suggestions: when "Capital Gains" is selected as type, suggest categories like "Stock Sale", "Property Sale", "Crypto". Write tests for income type selection and persistence. [@frontend]

- [x] Task 44: Wire tax computation into financial metrics and surplus ‚Äî Update `computeTotals` in `financial-state.ts` to compute after-tax monthly income using the tax engine. For each income item, annualize (using `normalizeToMonthly * 12`), compute tax based on the item's `incomeType` and the state's `country`/`jurisdiction`, then sum after-tax amounts and convert back to monthly. Add `monthlyAfterTaxIncome` and `totalTaxEstimate` to the totals return value. Update `computeMetrics` to use `monthlyAfterTaxIncome` for surplus calculation. Update surplus breakdown string to show "after-tax income - expenses". Add a new metric card or sub-line showing estimated annual tax and effective rate. Write unit tests comparing pre-tax and after-tax surplus calculations. [@fullstack]

- [x] Task 45: Show tax summary in dashboard and update projections ‚Äî Add a tax summary display in the dashboard: show estimated annual tax, effective tax rate, and after-tax monthly income as a new metric or as a detail row under Monthly Surplus. Update the projection engine (`projections.ts`) to use after-tax surplus instead of gross surplus for future projections. Update insights engine to potentially generate tax-related insights (e.g., "Your effective tax rate is X% ‚Äî capital gains income is taxed at a lower rate"). Ensure the projection chart correctly reflects after-tax growth. Write integration tests verifying projections use after-tax values. [@fullstack]

- [x] Task 46: [MILESTONE] Full E2E test for tax computation feature ‚Äî Comprehensive E2E test covering: country selector switching between CA and US, province/state selector updating based on country, income type selector on income rows, dashboard metrics updating to show after-tax values, surplus calculation reflecting tax deductions, capital gains income showing different effective rates than employment income, URL persistence of country/jurisdiction/incomeType across page reload. Capture screenshots at each step. [@qa]

- [x] Task 47: Add appreciation/depreciation field to properties with dynamic icon ‚Äî Add an `appreciation` field (annual %) to the Property interface. Allow negative values for depreciating assets like cars (e.g., -15% per year). Update the property icon dynamically: üè† for appreciating properties (positive or zero %), üöó for depreciating properties (negative %). Show the appreciation rate as a badge next to the property value (e.g., "+3%/yr" in green, "-15%/yr" in red). Wire appreciation into the projection engine so property values grow or shrink over time in the projection chart (currently property values are static). Update URL state encoding with a new `ap` field in CompactProperty. Pre-populate smart defaults: suggest +3% for "Home"/"House"/"Condo" names, -15% for "Car"/"Vehicle" names. Files: `src/components/PropertyEntry.tsx`, `src/lib/financial-state.ts`, `src/lib/projections.ts`, `src/lib/url-state.ts`. [@fullstack]

- [x] Task 48: Build asset allocation pie/doughnut chart ‚Äî Add a visual allocation chart (pie or doughnut) to the dashboard using recharts. Show how assets break down by category type (retirement accounts, savings, brokerage, stocks, property equity). Use a second ring or toggle to show allocation by a different dimension (e.g., by liquidity: liquid vs illiquid, or by region: CA vs US accounts). The chart should be interactive ‚Äî hover on a segment to see the category name, dollar value, and percentage. Click a segment to highlight the corresponding entry in the left panel. Use the existing warm color palette. Include a small legend below. Make it responsive (smaller on mobile, full size on desktop). Place it in the dashboard between the metric cards and insights section. [@frontend]

- [x] Task 49: Build expense breakdown visualization ‚Äî Add a visual breakdown of expenses using a horizontal stacked bar or doughnut chart in the dashboard. Show each expense category as a proportional segment with its name, amount, and percentage of total expenses. Include auto-generated categories (investment contributions, mortgage payments) distinguished with a subtle "auto" indicator. On hover, show the category detail. Sort segments largest-to-smallest for easy scanning. Use warm, distinguishable colors. Add a comparison bar or annotation showing income vs total expenses so users can visually see their surplus gap. Place near the Monthly Surplus metric card or in a dedicated "Spending Breakdown" section. [@frontend]

- [ ] Task 50: Build net worth breakdown waterfall chart ‚Äî Add a waterfall/bridge chart that visually explains how net worth is composed. Start from $0, show each asset category as a positive green block stacking up, then show each debt as a red block pulling down, ending at the net worth total. This makes it immediately clear what's contributing to and detracting from net worth. Use recharts BarChart with stacked/waterfall styling. Each block is hoverable with category name and amount. Include property equity as a distinct block (labeled separately from liquid assets). Show the final net worth bar prominently. Place this as an expandable/collapsible section in the dashboard, or as a tab alongside the allocation chart. [@frontend]

- [ ] Task 51: Build "Fast Forward" scenario modeling panel ‚Äî Add a scenario modeling section below the projection chart. Let users create "what if" scenarios by toggling individual debts on/off (e.g., "What if I paid off my car loan?"), adjusting monthly contribution amounts, changing income, or adding a one-time windfall (bonus, inheritance, property sale). Show the projected impact on net worth, runway, and debt-free date compared to the baseline. Display as a side-by-side comparison: "Current Plan" vs "Scenario" with delta values highlighted (e.g., "Debt-free 2 years sooner", "+$45k net worth at year 10"). Scenarios are temporary (not persisted to URL) ‚Äî they're exploratory tools. Use the existing projection engine with modified inputs. [@fullstack]

- [ ] Task 52: Add benchmark comparisons to dashboard ‚Äî Add a "How You Compare" section in the dashboard that shows how the user's key metrics stack up against aggregated benchmarks for their age group and country. Use published statistical data: median net worth by age (StatsCan for CA, Federal Reserve SCF for US), recommended savings rates, average debt-to-income ratios, and emergency fund benchmarks (3-6 months). Add an optional age input field (stored in URL state) to personalize benchmarks. Display as horizontal bar comparisons: user's value vs median vs recommended, with encouraging framing (e.g., "Your savings rate is above the median for your age group"). Never show benchmarks in a judgmental way ‚Äî frame gaps as opportunities, not failures. Include a small info icon explaining data sources. [@fullstack]

- [ ] Task 53: Build cash flow Sankey diagram ‚Äî Add a Sankey/flow diagram that visualizes money flowing from income sources through to expenses, savings, investments, and debt payments. Left side: income sources (salary, freelance, etc.). Middle: after-tax income pool. Right side: branches to each expense category, investment contributions, mortgage/debt payments, and remaining surplus. Line thickness proportional to amount. Interactive ‚Äî hover on a flow to highlight the path and show the dollar amount. Use a lightweight Sankey library compatible with React (e.g., recharts doesn't support Sankey natively, so evaluate d3-sankey with a thin React wrapper, or @nivo/sankey). Place as a collapsible "Cash Flow" section in the dashboard. This is the most visually distinctive Kubera-inspired feature. [@fullstack]

- [ ] Task 54: Add ROI performance tracking to stock holdings ‚Äî Enhance the StockEntry component to show investment performance metrics. For each stock holding with a cost basis, calculate and display: total return (current value - cost basis), percentage return, and annualized return if a purchase date is added (optional new field). Show gains in green, losses in red. Add a portfolio-level summary at the top of the Stocks section: total portfolio value, total gain/loss, and overall percentage return. In the dashboard, add a "Portfolio Performance" metric card or sub-section showing aggregate stock performance. For assets with ROI fields (from Task 22), show projected vs actual growth comparison where applicable. Store purchase date in URL state. [@fullstack]

- [ ] Task 55: [MILESTONE] Full E2E test for Kubera-inspired visualization features ‚Äî Comprehensive E2E test covering: asset allocation chart rendering with correct segments and hover interaction, expense breakdown chart with category proportions, net worth waterfall chart with positive/negative blocks, Fast Forward scenario panel with debt toggle and comparison display, benchmark section with age input and comparison bars, Sankey diagram rendering with flow paths, stock ROI performance display. Capture screenshots at each step. [@qa]
